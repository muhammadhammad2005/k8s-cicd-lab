name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Revision number to rollback to (leave empty for previous)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Minikube
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube

      - name: Start Minikube
        run: |
          minikube start --driver=docker --kubernetes-version=v1.28.0 --memory=2048 --cpus=2
          minikube status

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          minikube kubectl -- get nodes

      - name: Rollback deployment
        run: |
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            minikube kubectl -- rollout undo deployment/cicd-app --to-revision=${{ github.event.inputs.revision }}
          else
            minikube kubectl -- rollout undo deployment/cicd-app
          fi

      - name: Wait for rollback completion
        run: |
          minikube kubectl -- rollout status deployment/cicd-app --timeout=300s

      - name: Verify rollback
        run: |
          minikube kubectl -- get pods -l app=cicd-app
          minikube kubectl -- describe deployment cicd-app
